---
title: "Clonezilla – делаем recovery disk Windows XP"
layout: post
categories: linux
tags: [clonezilla, linux]
share: true
---

> Дистрибутив Clonezilla предназначен для создания на резервном накопителе образа установленной операционной системы.

При серьезных "поломках" операционную систему можно восстановить из этого образа до прежнего состояния. Clonezilla умеет работать с широким набором файловых систем (`fat`, `ntfs`, `ext2`, `ext3`, `ext4`, `ufs`, `ufs2`, `reiserfs`, `jfs`, `xfs`, `vmfs`) и операционных систем `x86` и `x86-64` (Windows, Linux, FreeBSD, OpenBSD, NetBSD, Mac OS (Intel)).

Для клонирования не поддерживаемых файловых систем в Clonezilla используется утилита `dd` в режиме копирования `sector-by-sector`. Имеется возможность создания из образа операционной системы `recovery disk` для автоматического восстановления.

Дистрибутив Clonezilla - из мира Open Source, поэтому абсолютно бесплатен. Является аналогом своих более знаменитых собратьев из мира Windows – Norton Ghost и Acronis True Image Home. Два последних продукта – платные (Acronis True Image Home позиционируется производителем как программа для домашнего использования, поэтому имеет 15-дневный испытательный строк и цену где-то в 150 рублей).

Итак, у меня стоит задача – снять образ с установленной Windows XP и создать из него диск автоматической инсталляции хрупкого творения ООО "Microsoft".

На оф. сайте имеются подробные инструкции по использованию дистрибутива для разных задач, но все статьи на английском. Так как я научился пользоваться программой совсем недавно, то решил сделать небольшой мануальчик на русском.

Весь процесс создания `recovery disk`'а будет разбит на три шага:

  1. скачивание дистрибутива, его запись на болванку и загрузка с Clonezilla LiveCD;
  2. создание образа установленной Windows XP;
  3. создание образа recovery disk'а из заранее созданного образа.

> Стоит обратить внимание, что описываемый способ создания образа и восстановления из него подходит только в том случае, когда размер (расположение) диска\раздела остается неизменным. То есть, если создан образ раздела `/dev/sda1` размером 19 Gb, то и восстанавливать образ нужно на раздел `/dev/sda1` размером 19 Gb. В противном случае могут возникнуть некоторые несоответствия. А именно – Clonezilla не может клонировать (а именно это и делается в этой статье – через создание образа `iso`) больший диск\раздел на меньший. Но клонировать меньший диск\раздел на больший – да, это ей по силам. О создании такого образа `iso` можно почитать про настройки режима эксперта.

## Шаг первый

  1. Загружаем последнюю версию дистрибутива с официального сайта
  2. Записываем скачанный iso-образ на болванку (Brasero, K3B, wodim – по вкусу)

## Шаг второй

1. Загружаемся с Clonezilla LiveCD. При запуске появляется основное меню дистрибутива с вариантами запуска программы:

![Загрузочное меню Clonezilla]({{site.url}}/images/uploads/2013/04/ocs-01-bootmenu.jpg)

Первые три варианта – запуск Clonezilla c поддержкой framebuffer'а `ncurces`. Варианты различаются только желаемым разрешением монитора.

Четвертый вариант – программа целиком загружается в оперативную память (RAM), освобождая CD/DVD-привод. Диск можно вытащить и использовать для других целей (например, запись на болванку из-под Clonezilla).

Идет загрузка и запуск Linux-системы, как обычно:

![Загрузка Clonezilla]({{site.url}}/images/uploads/2013/04/ocs-02-booting.jpg)

Затем окно выбора языка и кодировки консоли LiveCD:

![Выбор языка Clonezilla]({{site.url}}/images/uploads/2013/04/ocs-03-lang.jpg)

И окно выбора раскладки клавиатуры. Я выбрал вариант по умолчанию – "Don’t touch keymap" ("Не трогать раскладку"). Проблем с "клавой" во время работы в LiveCD не заметил:

![Раскладка клавиатуры Clonezilla]({{site.url}}/images/uploads/2013/04/ocs-04-keymap.jpg)

2. Окно выбора варианта входа в систему. Здесь выдается запрос, что необходимо сделать – перейти в режим пошагового wisard'а создания образа или перейти в bash-оболочку (командная строка) системы. Напомню, что Clonezilla построена на основе Debian Linux (Debian Sid – в частности). То есть, фактически – это урезанный Debian – без X-ов и части консольных программ. Выбираем первую строку и жмем <kbd>Enter</kbd>:

![Старт дистрибутива Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_login-in-system.jpg)

3. Здесь мы выбираем задачи, которые хотим реализовать в Clonezilla.

Первая строка – `device-image` – работа с образами диска (раздела). То есть, создание образа диска (раздела диска), восстановление диска (раздела диска) из образа.

Вторая строка – `device-device` – работа напрямую с дисками (разделами дисков). То есть, копирование\перемещение дисков (разделов) с одного на другой.

Мы будем работать с образами дисков, поэтому выбираем первую строку – `device-image`:

![Clonezilla - работа с образами диска]({{site.url}}/images/uploads/2013/04/clonezilla_device-image.jpg)

4. В этом окне выбираем режим работы:

  * `local_dev` – работа с локальными жесткими дисками (то есть, с винчестерами, что стоят внутри компа);
  * `ssh_server`, `samba_server`, `nfs_server` – варианты работы с удаленными жесткими дисками по сети (то есть, с винчестерами, которые находятся не внутри нашего компа, а где-то в другом месте);
  * `enter_shell` – войти в bash-оболочку и сделать все, что нужно, ручками&#8230;
  * `skip` – не пробовал, сказать ни чего не могу&#8230;

В этом окне выбираем опять первую строку – `local_dev` – работа с локальными жесткими дисками:

![Clonezilla - работа с локальными жесткими дисками]({{site.url}}/images/uploads/2013/04/clonezilla_local_dev.jpg)

5. После нажатия <kbd>Enter</kbd> появится строка, выделенная желтым цветом. В ней говорится, что если мы хотим сохранить создаваемый образ на флешку, то сейчас самое время воткнуть ее, затем подождать 5 секунд и нажать <kbd>Enter</kbd>. Система попытается автоматически определить ее и примонтировать в `/home/partimag`. Флешки такого объема (примерно нужно более 4Gb) у меня нет, поэтому просто снова нажимаю <kbd>Enter</kbd>. Система начнет сканировать жесткий диск на наличие разделов на нем:

![Clonezilla - сканировать жесткий диск]({{site.url}}/images/uploads/2013/04/clonezilla_disk-scan.jpg)

6. После сканирования появится окно со списком всех разделов, которые нашла Clonezilla на жестком диске. Здесь система спрашивает, какой раздел мы бы хотели выбрать в качестве целевого, то есть, тот раздел, куда будем сохранять создаваемый образ. Clonezilla примонтирует его в `/home/partimag` для дальнейшей работы. В качестве "мусорки" у меня служит `/dev/sda8` с файловой системой `reiserfs`. Выбираю его (клавишами-стрелками) и нажимаю <kbd>Enter</kbd>:

![Выбираем диск Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_select-partition.jpg)

7. Clonezilla "заглянет" в выбранный мною раздел и предложит выбрать папку (если таковые имеются на этом разделе), куда бы я хотел сохранять создаваемый ею образ. В строке вверху говорится об условии, по которым Clonezilla нашла\выбрала папки на этом разделе. Одно условие – папки должны быть только самого верхнего (top) уровня, то есть, корневые. Также она не предлагает (скрывает) папки, в именах которых имеются пробелы.

Я выбираю специально созданную для хранения образов папку `images` и нажимаю <kbd>Enter</kbd>:

![Директория хранения образов Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_store-images.jpg)

8. После просьбы программы нажать <kbd>Enter</kbd> появляется окно, где можно выбрать режим пошагового wizard'а:

  * упрощенный (Beginner);
  * эксперт (Expert) – можно добавить дополнительные параметры для создаваемого образа.

Выбираю первый вариант – "Beginner" – (*для новичка*). В принципе, ничего сложного нет:

![Режимы работы Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_beginner.jpg)

9. Следующее окно – что хотим делать с образом диска:

  * `savedisk` – сделать образ жесткого диска целиком;
  * `saveparts` – сделать образ отдельного раздела жесткого диска;
  * `restoredisk` – восстановить жесткий диск целиком из заранее созданного образа;
  * `restoreparts` – восстановить отдельный раздел жесткого диска из заранее созданного раздела;
  * `recovery-iso-zip` – создать загрузочный `recovery disk` (`iso` – для создания загрузочного диска, `zip` – для создания загрузочной флешки) из заранее созданного образа;
  * `exit` – выйти в bash-оболочку.

У меня еще не создан образ раздела, поэтому выбираю вторую строку – `saveparts` и нажимаю <kbd>Enter</kbd>:

![Clonezilla - образ отдельного раздела диска]({{site.url}}/images/uploads/2013/04/clonezilla_saveparts.jpg)

10. Система запрашивает имя создаваемого образа и предлагает вариант по умолчанию. Подправляю его немного и нажимаю снова <kbd>Enter</kbd>:

![Clonezilla - имя создаваемого образа]({{site.url}}/images/uploads/2013/04/clonezilla_image-name.jpg)

11. Clonezilla опять принимается за сканирование жесткого диска на наличие разделов. На этот раз она делает это для выбора раздела-источника, то есть, того раздела, образ которого мы будем создавать:

![Clonezilla - сканирование жесткого диска]({{site.url}}/images/uploads/2013/04/clonezilla_scan-hard-disk.jpg)

12. Снова "выкидывает" окно со списком найденных разделов. У меня Windows XP находится на первом разделе винчестера – `/dev/sda1`. Поэтому просто выделяю его (клавиша <kbd>Пробел</kbd>) и нажимаю <kbd>Enter</kbd>:

![Clonezilla - список найденных разделов]({{site.url}}/images/uploads/2013/04/clonezilla_list-images.jpg)

13. Система выводит внизу экрана уведомление с показом полной команды, которую она собирается выполнить и просит подтвердить ее нажатием клавиши <kbd>Enter</kbd>:

![Clonezilla - подтвердить команду]({{site.url}}/images/uploads/2013/04/clonezilla_confirm-command.jpg)

14. Следует еще одна строка с уведомлением (защита от дурака), куда и какой образ Clonezilla будет размещать\делать. Вводим буковку `y` и нажимаем <kbd>Enter</kbd>:

![Старт процесса Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_double-confirm.jpg)

15. Процесс пошел:

![Процесс создания образа Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_start-process.jpg)

17. По завершении выведет маленькое меню с вопросом – что ей делать дальше:

![Выбор дальнейших действий Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_next-steps.jpg)

  * (0) `Poweroff` – выключить компьютер;
  * (1) `Reboot` – перезагрузить компьютер;
  * (2) `Enter command line prompt` – перейти в режим командной строки (bash-оболочка);
  * (3) `Start over` – вернуться в начало wizard'а.

Так как я сделал только половину дела – создал образ раздела, то мне надо вернуться в начало, чтобы из полученного образа создать iso-образ загрузочного диска. Выбираю `3` и нажимаю <kbd>Enter</kbd>.

## Шаг третий

В последнем шаге создаем загрузочный iso-образ раздела. После возвращения в начало wizard'а все этапы повторяются вновь в точности так, как они показаны в "Шаге втором", вплоть до пункта `9`. Напомню, что в этом пункте необходимо выбрать задачу, выполняемую над диском (разделом диска), то есть создание образа диска (раздела), восстановление диска (раздела) из образа или создание загрузочного образа диска (флешки).

1. Выбираю строку `recovery-iso-zip` – создать загрузочный `recovery disk` (`iso` – для создания загрузочного диска, `zip` – для создания загрузочной флешки):

![Clonezilla - создание загрузочного диска]({{site.url}}/images/uploads/2013/04/clonezilla_make-recovery-disk.jpg)

2. Clonezilla найдет автоматически все уже созданные образы, имеющиеся на примонтированном в `/home/partimag` разделе. На скрине видно, что у меня их два – образ ArchLinux'а и образ Windows XP. Выбираю последний и нажимаю <kbd>Enter</kbd>:

![Clonezilla - найти созданные образы]({{site.url}}/images/uploads/2013/04/clonezilla_file-image-to-restore.jpg)

3. Здесь система спрашивает, какой раздел жесткого диска требуется восстановить:

![Clonezilla - раздел жесткого диска для восстановления]({{site.url}}/images/uploads/2013/04/clonezilla_select-image-to-restore.jpg)

4. Выбрать язык и кодировку консоли Clonezilla LiveCD:

![Clonezilla - язык и кодировка консоли]({{site.url}}/images/uploads/2013/04/clonezilla_console.jpg)

5. Выбрать раскладку клавиатуры. По умолчанию параметр None имеет значение американской раскладки `us`. Можно выбрать другую, по пути, подсказанному в шапке окна:

![Выбор раскладки клавиатуры Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_keymap.jpg)

6. Последнее окно – что мы хотим сделать из образа:

  * `iso` – создать загрузочный образ для прожига на CD/DVD-болванку;
  * `zip` – создать загрузочный образ для записи его на флешку;
  * `both` – создать сразу iso-образ и zip-образ.

Выбираю первую строку – `iso` – и нажимаю <kbd>Enter</kbd>:

![Clonezilla - загрузочный образ для прожига]({{site.url}}/images/uploads/2013/04/clonezilla_iso-image-to-burn.jpg)

7. Система выводит на экран полную команду, которую она собирается выполнить и просит нашего подтверждения. Нажимаю <kbd>Enter</kbd>:

![Clonezilla - подтверждение выполнения команды]({{site.url}}/images/uploads/2013/04/clonezilla_type-of-file-for-recovery.jpg)

8. Clonezilla копирует файлы образа в рабочую директорию и подсчитывает размер iso-образа, который должен получиться. Если iso-образ больше по объему, чем CD или DVD-болванка, программа заботливо сообщает об этом и просит подтвердить выбор, если мы знаем, что делаем:

![Подтверждение действий Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_confirm-of-size-image.jpg)

9. Я буду создавать образ размером с DVD-болванку (а программа предупреждает о слишком большом размере для CD-болванки), поэтому даю утвердительный ответ. Процесс пошел:

![Процесс создания iso-образа в Clonezilla]({{site.url}}/images/uploads/2013/04/clonezilla_make-iso-image-process.jpg)

10. По окончании процесса Clonezilla опять выведет меню с выбором дальнейших действий. Выбираю `1` для перезагрузки. Дальше полученный образ можно записать на болванку в любой программе для записи. Диск аварийного восстановления Windows XP готов:

![Процесс Clonezilla завершен]({{site.url}}/images/uploads/2013/04/clonezilla_iso-recovery-finished.jpg)

## P.S.

1. Clonezilla не умеет разделять полученный образ на несколько частей, если размер образа больше размера болванки CD или DVD.

2. При создании мануальчика столкнулся со следующей проблемой – снятие скриншотов в консоли Clonezilla. Консольных утилит для снятия скриншотов (`fbgrab`, `fbshot`, `fbdump`, `fbcat` или что-либо подобное) в дистрибутиве я не нашел. Решил задачу в скачивании deb-пакета `fbgrab` и его установки через `dpkg` (хоть это есть в Clonezilla). С вопросом по поводу данного неудобства обратился на форум Clonezilla:

> I have a question. How can I make screenshots, when I start Clonezilla? I need such screens for me. I can’t find such applications as fbgrab or fbshot in Clonezilla. And I never take screenshots in pure console (only X). Please, help me.

На что мною был получен ответ:

> Thanks for this idea. fbgrab was added to Clonezilla live 1.2.4-14, and it’s available in testing branch. Please give it a try. Steven

На этом все.

---